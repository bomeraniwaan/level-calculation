<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>レベル到達時間 – 共有型計算ツール</title>
  <meta name="robots" content="noindex, nofollow" />
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121821;
      --muted: #7c8aa0;
      --text: #e6edf3;
      --accent: #58a6ff;
      --accent-2: #2ea043;
      --danger: #ef4444;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 24px; background: linear-gradient(180deg, #0b0f14 0%, #0d131b 100%);
      color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN",
      "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", Meiryo, sans-serif; line-height: 1.6;
    }
    h1 { font-size: 1.6rem; margin: 0 0 12px; }
    .sub { color: var(--muted); font-size: .95rem; margin-bottom: 18px; }
    .wrap { max-width: 920px; margin: 0 auto; }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border: 1px solid rgba(255,255,255,.08); border-radius: var(--radius); padding: 18px; backdrop-filter: blur(6px);
      box-shadow: 0 6px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .card h2 { font-size: 1.2rem; margin: 0 0 10px; }
    label { display:block; font-size: .92rem; color: var(--muted); margin-bottom: 6px; }
    input[type="number"], input[type="text"], select {
      width: 100%; background: #0e141b; color: var(--text); border: 1px solid rgba(255,255,255,.1);
      border-radius: 10px; padding: 10px 12px; font-size: 1rem; outline: none; transition: border-color .15s ease;
    }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(88,166,255,.15); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .footer { margin-top: 14px; display:flex; gap: 10px; flex-wrap:wrap; align-items:center; }
    .small { font-size: .85rem; color: var(--muted); }
    .muted { color: var(--muted); }

    .btn { appearance:none; border: 1px solid rgba(255,255,255,.12); color: var(--text); background: #121a24; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: transform .04s ease, background .15s ease, border-color .15s ease; }
    .btn:hover { background: #182231; border-color: rgba(255,255,255,.2); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: linear-gradient(180deg, #1f6feb, #1158c7); border-color: rgba(17,88,199,.9); }
    .btn.success { background: linear-gradient(180deg, #2ea043, #238636); border-color: rgba(35,134,54,.9); }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid rgba(255,255,255,.08); padding: 8px 6px; text-align: left; font-size: .95rem; }
    th { color: var(--muted); font-weight: 600; }
    .right { text-align: right; }
    .hidden { display: none !important; }

    .modal { position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.5); z-index: 50; }
    .modal .panel { width: min(740px, 96vw); max-height: 80vh; overflow: auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>レベル到達時間（1時間あたりの獲得ペースから算出）</h1>
    <div class="sub">②と③は <b>M表記（百万単位）</b> で入力します。内部では×1,000,000して計算します。状態はURLハッシュ（#以降）に保存できます。</div>

    <section class="card">
      <h2>入力</h2>
      <div class="row-3">
        <div>
          <label>① 1時間に溜まる経験値（/h）<span class="small">（Mではありません）</span></label>
          <input id="perHourXp" type="number" inputmode="decimal" min="0" placeholder="例：2500000" value="0" />
        </div>
        <div>
          <label>② レベル到達経験値（M）</label>
          <input id="targetXpM" type="number" inputmode="decimal" min="0" placeholder="例：24" value="0" />
        </div>
        <div>
          <label>③ 現在の経験値（M）</label>
          <input id="currentXpM" type="number" inputmode="decimal" min="0" placeholder="例：14" value="0" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>レベル選択（任意・判明次第追加）</label>
          <div class="row" style="gap:8px; grid-template-columns: 1fr auto;">
            <select id="levelSelect"><option value="">— レベル未選択 —</option></select>
            <button class="btn" id="manageLevels">レベル表を編集</button>
          </div>
          <div class="small" style="margin-top:6px">レベルを選ぶと②が自動入力され、<b>次レベル</b>も同時計算します（存在する場合）。</div>
        </div>
        <div>
          <label>共有</label>
          <div class="row" style="gap:8px; grid-template-columns: auto auto 1fr; align-items:center;">
            <button class="btn primary" id="genLink">共有リンクを生成</button>
            <button class="btn success" id="copyLink">コピー</button>
            <input id="shareUrl" type="text" readonly placeholder="共有リンクがここに表示されます" />
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h2>結果</h2>
      <table>
        <thead>
          <tr>
            <th style="width:40%">対象</th>
            <th style="width:30%">所要時間</th>
            <th style="width:30%">到達時刻（東京）</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="rowSelLabel">手動入力</td>
            <td id="rowSelTime">—</td>
            <td id="rowSelEta">—</td>
          </tr>
          <tr id="rowNextLevel" class="hidden">
            <td id="rowNextLabel">次レベル</td>
            <td id="rowNextTime">—</td>
            <td id="rowNextEta">—</td>
          </tr>
        </tbody>
      </table>
    </section>

    <div class="small" style="margin-top:14px; color: var(--muted)">v1.2 – クライアントサイドのみ／No Cookie／No Tracking</div>
  </div>

  <!-- ===== Modal: Level Manager ===== -->
  <div class="modal" id="levelModal" aria-hidden="true">
    <div class="panel card">
      <h2>レベル表の編集（M表記）</h2>
      <div class="small">例：130レベルが 12,345M のときは「130」と「12345」を入力。保存後、プルダウンに反映されます。</div>
      <div style="overflow:auto; margin-top:10px">
        <table>
          <thead>
            <tr><th style="width:30%">レベル</th><th style="width:40%">必要経験値（M）</th><th></th></tr>
          </thead>
          <tbody id="levelTbody"></tbody>
        </table>
      </div>
      <div class="footer">
        <button class="btn" id="addLevelRow">＋ 行を追加</button>
        <button class="btn success" id="saveLevels">保存</button>
        <button class="btn" id="closeLevels">閉じる</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Utilities =====
    const fmt = new Intl.NumberFormat('ja-JP');
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const M = 1_000_000;
    const TZ = 'Asia/Tokyo';

    function encodeStateToHash(state) {
      const json = JSON.stringify(state);
      const bytes = new TextEncoder().encode(json);
      let bin = '';
      for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
      const b64 = btoa(bin).replace(/=+$/,'');
      return '#' + b64;
    }
    function decodeHashToState(hash) {
      const b64 = hash.replace(/^#/, '');
      if (!b64) return null;
      try {
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for (let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
        const json = new TextDecoder().decode(bytes);
        return JSON.parse(json);
      } catch (e) { console.warn('Invalid hash state', e); return null; }
    }

    function formatDurationHours(h) {
      if (!Number.isFinite(h) || h < 0) return '—';
      if (h === 0) return '0分';
      const totalMin = Math.round(h * 60);
      const days = Math.floor(totalMin / (60*24));
      const hours = Math.floor((totalMin % (60*24)) / 60);
      const minutes = totalMin % 60;
      const parts = [];
      if (days) parts.push(`${days}日`);
      if (hours || days) parts.push(`${hours}時間`);
      parts.push(`${minutes}分`);
      return parts.join('');
    }
    function formatJSTFromNow(hours) {
      if (!Number.isFinite(hours) || hours < 0) return '—';
      const ms = Math.round(hours * 3600_000);
      const dt = new Date(Date.now() + ms);
      const f = new Intl.DateTimeFormat('ja-JP', { timeZone: TZ, month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', weekday: 'short' });
      return f.format(dt);
    }

    // ===== State =====
    const state = {
      perHourXp: 0,           // ①（/h）Mではない
      targetXpM: 0,           // ②（M）
      currentXpM: 0,          // ③（M）
      levels: [],             // [{level:130, xpM:12345}, ...]
      selectedLevel: ''       // '' or number
    };

    function readUIToState() {
      state.perHourXp = Number($('#perHourXp').value) || 0;
      state.targetXpM = Number($('#targetXpM').value) || 0;
      state.currentXpM = Number($('#currentXpM').value) || 0;
      state.selectedLevel = $('#levelSelect').value ? Number($('#levelSelect').value) : '';
    }
    function writeStateToUI() {
      $('#perHourXp').value = state.perHourXp ?? 0;
      $('#targetXpM').value = state.targetXpM ?? 0;
      $('#currentXpM').value = state.currentXpM ?? 0;
      renderLevelsSelect();
      computeLevelTime();
    }

    // ===== Levels =====
    function renderLevelsSelect() {
      const sel = $('#levelSelect');
      sel.innerHTML = '<option value="">— レベル未選択 —</option>' +
        state.levels
          .slice().sort((a,b)=>a.level-b.level)
          .map(l => `<option value="${l.level}" ${String(state.selectedLevel)===String(l.level)?'selected':''}>Lv.${l.level}（${fmt.format(l.xpM)}M）</option>`)
          .join('');
    }
    function openLevelModal() {
      const modal = $('#levelModal');
      const tbody = $('#levelTbody');
      tbody.innerHTML = '';
      const arr = state.levels.slice().sort((a,b)=>a.level-b.level);
      if (arr.length === 0) arr.push({level: 130, xpM: 0}); // 初期例
      arr.forEach((l) => tbody.appendChild(renderLevelRow(l.level, l.xpM)));
      modal.style.display = 'grid';
      modal.setAttribute('aria-hidden','false');
    }
    function closeLevelModal() {
      const modal = $('#levelModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }
    function renderLevelRow(level, xpM) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="number" min="1" value="${level}" data-k="level"/></td>
        <td><input type="number" min="0" value="${xpM}" data-k="xpM"/></td>
        <td class="right"><button class="btn" data-del>削除</button></td>
      `;
      tr.querySelector('[data-del]').addEventListener('click', ()=> tr.remove());
      return tr;
    }
    function saveLevelsFromModal() {
      const rows = Array.from($('#levelTbody').querySelectorAll('tr'));
      const list = [];
      rows.forEach(r => {
        const level = Number(r.querySelector('[data-k="level"]').value) || 0;
        const xpM = Number(r.querySelector('[data-k="xpM"]').value) || 0;
        if (level>0) list.push({level, xpM});
      });
      state.levels = list;
      localStorage.setItem('xp-levels', JSON.stringify(state.levels));
      renderLevelsSelect();
      // レベル選択が有効なら②を更新
      if (state.selectedLevel) {
        const found = state.levels.find(l=>l.level===state.selectedLevel);
        if (found) { state.targetXpM = Number(found.xpM)||0; $('#targetXpM').value = state.targetXpM; }
      }
      computeLevelTime();
      toast('レベル表を保存しました');
      closeLevelModal();
    }

    // ===== Compute =====
    function computeLevelTime() {
      readUIToState();
      const perHour = state.perHourXp; // ①（/h）
      const targetM = state.targetXpM; // ②（M）
      const currentM = state.currentXpM; // ③（M）

      const resSel = calcTime(perHour, targetM, currentM);
      setRow('Sel', resSel, state.selectedLevel ? `Lv.${state.selectedLevel}` : '手動入力');

      const rowNext = $('#rowNextLevel');
      if (state.selectedLevel) {
        const lvList = state.levels.slice().sort((a,b)=>a.level-b.level);
        const idx = lvList.findIndex(l=>l.level===state.selectedLevel);
        if (idx >= 0 && idx+1 < lvList.length) {
          const next = lvList[idx+1];
          const resNext = calcTime(perHour, Number(next.xpM)||0, currentM);
          setRow('Next', resNext, `Lv.${next.level}`);
          rowNext.classList.remove('hidden');
        } else {
          rowNext.classList.add('hidden');
        }
      } else {
        rowNext.classList.add('hidden');
      }
    }

    function calcTime(perHour, targetM, currentM) {
      const target = (Number(targetM)||0) * M;
      const current = (Number(currentM)||0) * M;
      const remain = Math.max(0, target - current);
      let hours;
      if (remain === 0) hours = 0; else hours = perHour > 0 ? (remain / perHour) : Infinity;
      return {
        hours,
        eta: formatJSTFromNow(hours)
      };
    }
    function setRow(suf, r, label) {
      $('#row'+suf+'Label').textContent = label;
      $('#row'+suf+'Time').textContent = formatDurationHours(r.hours);
      $('#row'+suf+'Eta').textContent = r.eta;
    }

    // ===== Sharing =====
    function genShareUrl() {
      readUIToState();
      const stateForLink = {
        perHourXp: state.perHourXp,
        targetXpM: state.targetXpM,
        currentXpM: state.currentXpM,
        selectedLevel: state.selectedLevel,
        levels: state.levels
      };
      const hash = encodeStateToHash(stateForLink);
      const base = location.origin + location.pathname;
      const url = base + hash;
      $('#shareUrl').value = url;
      history.replaceState(null, '', url);
    }
    async function copyShareUrl() {
      const val = $('#shareUrl').value || (genShareUrl(), $('#shareUrl').value);
      try {
        await navigator.clipboard.writeText(val);
        toast('リンクをコピーしました');
      } catch {
        const inp = $('#shareUrl');
        inp.focus(); inp.select(); document.execCommand('copy');
        toast('クリップボードへコピーしました');
      }
    }

    // ===== Toast =====
    let toastTimer = 0;
    function toast(msg) {
      let el = document.getElementById('toast');
      if (!el) {
        el = document.createElement('div');
        el.id = 'toast';
        el.style.position = 'fixed'; el.style.left = '50%'; el.style.bottom = '24px'; el.style.transform = 'translateX(-50%)';
        el.style.padding = '10px 14px'; el.style.background = '#111a22'; el.style.border = '1px solid rgba(255,255,255,.16)';
        el.style.borderRadius = '10px'; el.style.boxShadow = '0 8px 24px rgba(0,0,0,.35)'; el.style.zIndex = '9999';
        document.body.appendChild(el);
      }
      el.textContent = msg; el.style.opacity = '1'; el.style.transition = 'opacity .3s ease';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { el.style.opacity = '0'; }, 1800);
    }

    // ===== Wire up =====
    function wire() {
      ['#perHourXp','#targetXpM','#currentXpM']
        .forEach(sel => $(sel).addEventListener('input', computeLevelTime));
      $('#levelSelect').addEventListener('change', () => {
        readUIToState();
        if (state.selectedLevel) {
          const found = state.levels.find(l=>l.level===state.selectedLevel);
          if (found) { state.targetXpM = Number(found.xpM)||0; $('#targetXpM').value = state.targetXpM; }
        }
        computeLevelTime();
      });
      $('#manageLevels').addEventListener('click', openLevelModal);
      $('#genLink').addEventListener('click', genShareUrl);
      $('#copyLink').addEventListener('click', copyShareUrl);

      // modal buttons
      $('#addLevelRow').addEventListener('click', () => {
        $('#levelTbody').appendChild(renderLevelRow('', ''));
      });
      $('#saveLevels').addEventListener('click', saveLevelsFromModal);
      $('#closeLevels').addEventListener('click', closeLevelModal);

      // close modal on backdrop
      $('#levelModal').addEventListener('click', (e) => { if (e.target.id === 'levelModal') closeLevelModal(); });
    }

    // ===== Init =====
    (function init(){
      wire();
      // restore levels from localStorage for convenience
      try {
        const saved = localStorage.getItem('xp-levels');
        if (saved) state.levels = JSON.parse(saved);
      } catch {}

      const fromHash = decodeHashToState(location.hash);
      if (fromHash) { Object.assign(state, { ...state, ...fromHash }); }
      writeStateToUI();
    })();
  </script>
</body>
</html>
