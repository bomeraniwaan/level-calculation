<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>レベル到達時間計算</title>
  <meta name="robots" content="noindex, nofollow" />
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121821;
      --muted: #7c8aa0;
      --text: #e6edf3;
      --accent: #58a6ff;
      --danger: #ef4444;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      background: linear-gradient(180deg, #0b0f14 0%, #0d131b 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto,
        "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Noto Sans JP",
        "Yu Gothic UI", Meiryo, sans-serif;
      line-height: 1.6;
    }
    h1 { font-size: 1.6rem; margin: 0 0 12px; }
    .sub { color: var(--muted); margin-bottom: 16px; }
    .wrap { max-width: 820px; margin: 0 auto; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 18px;
      backdrop-filter: blur(6px);
      box-shadow: 0 6px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06);
      margin-bottom: 16px;
    }
    label { display:block; font-size:.9rem; color:var(--muted); margin-bottom:4px; }
    input[type="number"], select {
      width: 100%;
      background: #0e141b;
      color: var(--text);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 10px;
      padding: 9px 11px;
      font-size: 1rem;
      outline: none;
    }
    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(88,166,255,.16);
    }
    .row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid rgba(255,255,255,.08); padding:8px 6px; }
    th { color:var(--muted); text-align:left; }
    .hidden { display:none !important; }
    .small { font-size:.8rem; color:var(--muted); }
    .btn {
      appearance: none;
      border: 1px solid rgba(255,255,255,.12);
      background: #121a24;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn:hover { background:#182231; }
    .share-grid {
      display:grid;
      grid-template-columns: auto auto 1fr;
      gap: 10px;
      align-items: center;
    }
    input[readonly] {
      background: #0b1015;
    }
    .error {
      background: rgba(239,68,68,.12);
      border: 1px solid rgba(239,68,68,.45);
      color: #fecaca;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: .8rem;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>レベル到達時間計算</h1>
    <div class="sub">
      ②と③はM表記（百万単位）で入力します。内部で×1,000,000して計算します。<br>
      レベルリストは下記のGoogleスプレッドシートから取得します。
    </div>

    <section class="card">
      <h2>入力</h2>
      <div class="row">
        <div>
          <label>① 1時間に溜まる経験値（/h）<span class="small">（Mではありません）</span></label>
          <input id="perHourXp" type="number" min="0" value="0" placeholder="例：2500000">
        </div>
        <div>
          <label>② レベル到達経験値（M）</label>
          <input id="targetXpM" type="number" min="0" value="0" placeholder="例：24">
        </div>
        <div>
          <label>③ 現在の経験値（M）</label>
          <input id="currentXpM" type="number" min="0" value="0" placeholder="例：14">
        </div>
      </div>

      <div style="margin-top:12px">
        <label>レベル選択（シートから読込）</label>
        <select id="levelSelect">
          <option value="">— レベル未選択 —</option>
        </select>
        <div id="levelLoadMsg" class="small" style="margin-top:4px;">シートから読込中…</div>
      </div>
    </section>

    <section class="card">
      <h2>結果</h2>
      <table>
        <thead>
          <tr>
            <th style="width:40%">対象</th>
            <th style="width:30%">所要時間</th>
            <th style="width:30%">到達時刻（東京）</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="rowSelLabel">手動入力</td>
            <td id="rowSelTime">—</td>
            <td id="rowSelEta">—</td>
          </tr>
          <tr id="rowNextLevel" class="hidden">
            <td id="rowNextLabel">次レベル</td>
            <td id="rowNextTime">—</td>
            <td id="rowNextEta">—</td>
          </tr>
        </tbody>
      </table>
      <div id="calcError" class="error hidden"></div>
    </section>

    <section class="card">
      <h2>共有</h2>
      <p class="small">入力値だけをURLに埋め込んで共有します（レベル表はシートから毎回取得します）。</p>
      <div class="share-grid">
        <button id="genLink" type="button" class="btn">共有リンクを生成</button>
        <button id="copyLink" type="button" class="btn">コピー</button>
        <input id="shareUrl" type="text" readonly placeholder="共有リンクがここに表示されます">
      </div>
    </section>

    <div class="small" style="margin-top:10px; color:var(--muted);">v1.3 – Google Sheets(gviz)読込版</div>
  </div>

  <script>
    // このシートIDで固定
    const SHEET_ID = '1Zla4Jkw_Rk86d8JJ360LLlDFmnfzoDRSUurxjEIDDrk';
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
    const M = 1_000_000;
    const TZ = 'Asia/Tokyo';

    const $ = (s) => document.querySelector(s);

    function formatDuration(hours) {
      if (!Number.isFinite(hours) || hours < 0) return '—';
      if (hours === 0) return '0分';
      const totalMin = Math.round(hours * 60);
      const d = Math.floor(totalMin / (60 * 24));
      const h = Math.floor((totalMin % (60 * 24)) / 60);
      const m = totalMin % 60;
      const parts = [];
      if (d) parts.push(`${d}日`);
      if (h || d) parts.push(`${h}時間`);
      parts.push(`${m}分`);
      return parts.join('');
    }

    function formatEta(hours) {
      if (!Number.isFinite(hours) || hours < 0) return '—';
      const ms = Math.round(hours * 3600_000);
      const dt = new Date(Date.now() + ms);
      const f = new Intl.DateTimeFormat('ja-JP', {
        timeZone: TZ,
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        weekday: 'short'
      });
      return f.format(dt);
    }

    function calcTime(perHour, targetM, currentM) {
      const target = (Number(targetM) || 0) * M;
      const current = (Number(currentM) || 0) * M;
      const remain = Math.max(0, target - current);
      let hours;
      if (remain === 0) {
        hours = 0;
      } else {
        hours = perHour > 0 ? remain / perHour : Infinity;
      }
      return { hours, eta: formatEta(hours) };
    }

    async function fetchLevelsFromSheet() {
      const loadMsg = $('#levelLoadMsg');
      try {
        const res = await fetch(GVIZ_URL);
        const text = await res.text();
        // gviz形式 → {}の部分だけを抜いてJSON化
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        const rows = json.table.rows;
        const levels = [];
        // 1行目はヘッダ想定なので飛ばす
        for (let i = 1; i < rows.length; i++) {
          const r = rows[i];
          // A列: level, B列: xpM
          const levelCell = r.c[0];
          const xpMCell = r.c[1];
          if (!levelCell) continue;
          const level = Number(levelCell.v);
          const xpM = xpMCell ? Number(xpMCell.v) : 0;
          levels.push({ level, xpM });
        }
        loadMsg.textContent = `シートから ${levels.length} 件読み込みました`;
        return levels.sort((a,b)=>a.level - b.level);
      } catch (e) {
        console.warn('level fetch error', e);
        loadMsg.textContent = 'シートの読み込みに失敗しました。手動入力でご利用ください。';
        return [];
      }
    }

    function renderLevelsToSelect(levels) {
      const sel = $('#levelSelect');
      sel.innerHTML = '<option value="">— レベル未選択 —</option>';
      levels.forEach(l => {
        const opt = document.createElement('option');
        opt.value = String(l.level);
        opt.textContent = `Lv.${l.level}（${l.xpM}M）`;
        sel.appendChild(opt);
      });
    }

    function warning(msg) {
      const el = $('#calcError');
      el.textContent = msg;
      el.classList.remove('hidden');
    }
    function clearWarning() {
      $('#calcError').classList.add('hidden');
    }

    function compute(levels) {
      clearWarning();
      const perHour = Number($('#perHourXp').value) || 0;
      const targetM = Number($('#targetXpM').value) || 0;
      const currentM = Number($('#currentXpM').value) || 0;
      const selLevelVal = $('#levelSelect').value ? Number($('#levelSelect').value) : null;

      if (perHour < 0 || targetM < 0 || currentM < 0) {
        warning('0以上の数値を入力してください。');
      }

      // 選択中の行
      const res = calcTime(perHour, targetM, currentM);
      $('#rowSelLabel').textContent = selLevelVal ? `Lv.${selLevelVal}` : '手動入力';
      $('#rowSelTime').textContent = formatDuration(res.hours);
      $('#rowSelEta').textContent = res.eta;

      // 次レベル
      const nextRow = $('#rowNextLevel');
      if (selLevelVal && levels.length) {
        const idx = levels.findIndex(l => l.level === selLevelVal);
        if (idx >= 0 && idx + 1 < levels.length) {
          const next = levels[idx + 1];
          const resNext = calcTime(perHour, next.xpM, currentM);
          $('#rowNextLabel').textContent = `Lv.${next.level}`;
          $('#rowNextTime').textContent = formatDuration(resNext.hours);
          $('#rowNextEta').textContent = resNext.eta;
          nextRow.classList.remove('hidden');
        } else {
          nextRow.classList.add('hidden');
        }
      } else {
        nextRow.classList.add('hidden');
      }
    }

    function encodeStateToHash() {
      const state = {
        perHourXp: Number($('#perHourXp').value) || 0,
        targetXpM: Number($('#targetXpM').value) || 0,
        currentXpM: Number($('#currentXpM').value) || 0,
        selectedLevel: $('#levelSelect').value || ''
        // levels はシートから毎回取るのでURLに含めない
      };
      const json = JSON.stringify(state);
      const bytes = new TextEncoder().encode(json);
      let bin = '';
      for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
      const b64 = btoa(bin).replace(/=+$/, '');
      return '#' + b64;
    }

    function decodeStateFromHash() {
      const hash = location.hash.replace(/^#/, '');
      if (!hash) return null;
      try {
        const bin = atob(hash);
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
        const json = new TextDecoder().decode(bytes);
        return JSON.parse(json);
      } catch (e) {
        console.warn('invalid hash', e);
        return null;
      }
    }

    async function init() {
      // 1. シートからレベルを取得
      const levels = await fetchLevelsFromSheet();
      renderLevelsToSelect(levels);

      // 2. URLハッシュから入力値を復元
      const st = decodeStateFromHash();
      if (st) {
        $('#perHourXp').value = st.perHourXp ?? 0;
        $('#targetXpM').value = st.targetXpM ?? 0;
        $('#currentXpM').value = st.currentXpM ?? 0;
        if (st.selectedLevel) {
          $('#levelSelect').value = st.selectedLevel;
        }
      }

      // 3. 初回計算
      compute(levels);

      // 4. イベント
      ['#perHourXp','#targetXpM','#currentXpM','#levelSelect'].forEach(sel => {
        $(sel).addEventListener('input', () => compute(levels));
      });

      $('#genLink').addEventListener('click', () => {
        const hash = encodeStateToHash();
        const url = location.origin + location.pathname + hash;
        $('#shareUrl').value = url;
        history.replaceState(null, '', url);
      });

      $('#copyLink').addEventListener('click', async () => {
        if (!$('#shareUrl').value) {
          const hash = encodeStateToHash();
          const url = location.origin + location.pathname + hash;
          $('#shareUrl').value = url;
          history.replaceState(null, '', url);
        }
        try {
          await navigator.clipboard.writeText($('#shareUrl').value);
          alert('リンクをコピーしました');
        } catch {
          alert('クリップボードにコピーできませんでした');
        }
      });
    }

    init();
  </script>
</body>
</html>
